#!/bin/bash
set -e

if [ ! -f composer.json ] || [ "$#" -ne 1 ] || [[ ! "$1" =~ ^(7|8)$ ]]; then echo "Usage (in composer root): $0 [DrupalMajorVersion]"; exit 1; fi
major=$1

# Dirs.
targetDir=.
binDir=$(dirname $(realpath "$0"))
ourDir=$(dirname "$binDir")

set -v

# Copy our stuff.
rsync -rv "$ourDir/copy/" "$targetDir/"

# Symlink our stuff.
symlinkDir=$ourDir/symlink
for relFile in $(cd $symlinkDir; find . -type f); do
  mkdir -p $(dirname $targetDir/$relFile)
  ln -rsf "$symlinkDir/$relFile" "$targetDir/$relFile"
done

# Create Hash salt.
[-f $targetDir/custom/hash_salt.php ] || $binDir/settings-hashsalt $targetDir/custom/hash_salt.php

# Copy container yamls.
[-f web/sites/default/services.yml ] || cp web/sites/default/default.services.yml web/sites/default/services.yml

# Pin php version to 7.0 (FSB) to prevent 7.1 packages in composer.lock.
composer config platform.php 7.0.17
echo "Wanna update packages?"
select yn in "Yes" "No"; do
  case $yn in
      Yes ) composer update; break;;
      No ) break;;
  esac
done

