#!/bin/bash
set -e

if [ ! -f composer.json ] || [ "$#" -ne 1 ] || [[ ! "$1" =~ ^(7|8)$ ]]; then echo "Usage (in composer root): $0 [DrupalMajorVersion]"; exit 1; fi
major="$1"

# Dirs.
targetDir=.
binDir=$(dirname $(realpath "$0"))
ourDir=$(dirname "$binDir")

#set -v

# Migrations.
[ -f drush/drushrc.php ] && sed -i -e "s:'../settings/generated/local/siteurl.php':'../settings/generated/siteurl.php':g" drush/drushrc.php

# Ensure web and docroot dirs.
[ -d web ] && [ ! -e docroot ] && ln -s web docroot
[ -d docroot ] && [ ! -e web ] && ln -s docroot web

# Copy stuff that is trivial or needed before the build.
rsync -r --links --keep-dirlinks "$ourDir/copy/" "$targetDir/"
rsync -r --links --keep-dirlinks "$ourDir/copy$major/" "$targetDir/"

# Scaffold (copy if not exists).
rsync -r --ignore-existing --keep-dirlinks "$ourDir/scaffold/" "$targetDir/"
rsync -r --ignore-existing --keep-dirlinks "$ourDir/scaffold$major/" "$targetDir/"

# Replacement for ln -r in busybox. https://stackoverflow.com/a/24848739/606859
function relative() {
s=$(cd ${1%%/};pwd); d=$(cd $2;pwd); while [ "${d#$s/}" == "${d}" ]
do s=$(dirname $s);b="../${b}"; done; echo ${b}${d#$s/}
}

# Symlink.
for symlinkDir in "$ourDir/symlink" "$ourDir/symlink$major"; do
  relSymlinkDir=$(relative $symlinkDir $targetDir)
  for relFile in $(cd "$symlinkDir"; find . -type f); do
    mkdir -p $(dirname "$targetDir/$relFile")
    ln -sf "$symlinkDir/$relFile" "$targetDir/$relFile"
  done
done

# Create Hash salt.
hash_salt_file="$targetDir/settings/generated/custom/hash_salt.php"
generate_hash_salt() {
  "$binDir/settings-hashsalt" "$hash_salt_file"
}
if [ -f "$hash_salt_file" ]
then
  echo "Hash salt exists. To generate: \"$binDir/settings-hashsalt\" \"$hash_salt_file\""
else
  generate_hash_salt
fi

# Copy D8 container yamls.
[ "$major" -eq 8  ] && ( [ -f web/sites/default/services.yml ] || cp web/sites/default/default.services.yml web/sites/default/services.yml )
